<!DOCTYPE html>
<html>
    <head lang="ko">
        <script type="text/javascript" src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
        <script type="text/javascript">
            $(document).ready(function(){
                var start_fn = (is_caller, call_token) => { 
                    console.log('start chat');

                    var socket = io.connect("http://" + document.domain + ":" + location.port + "/mynamespace");
                    console.log('connecting socket.io server');

                    socket.on("chat_response", function(message){
                        console.log('chat_response socket.io event');

                        $('#chat_received').append("<p>" + message.username + ": " + message.data + "</p>");
                    });

                    $("form#chat_broadcast").submit(function(event){
                        if ($("#input-data").val() == "") {
                            console.log('no chat data, no sent');
                            return false;
                        }

                        socket.emit("chat", {data: $("#input-data").val()});
                        console.log('chat sent');

                        $("#input-data").val("");
                        return false;
                    })

                    var peer_connection = new RTCPeerConnection({
                        "iceServers": [
                            { "urls": "stun:stun.l.google.com:19302" }
                        ]
                    });
                    console.log("creating rtcpeerconnection");

                    // generic handler that sends any ice candidates to the other peer
                    peer_connection.onicecandidate = function (ice_event) {
                        console.log('onicecandidate event');

                        if (ice_event.candidate) {
                            socket.emit("new_ice_candidate", {candidate: ice_event.candidate});
                            console.log('sent new_ice_candidate');
                        }
                    };

                    // display remote video streams when they arrive using local <video> MediaElement
                    peer_connection.onaddstream = function (event) {
                        console.log('onaddstream event');

                        const mediaObj = $('#remote_video');
                        mediaObj.srcObject = event.stream;
                        mediaObj.play();
                    };

                    navigator.getUserMedia({
                        video: true,
                        audio: true
                    }, function(stream){
                        console.log('getusermedia succeed');

                        var mediaObj = $('#local_video')[0];
                        mediaObj.srcObject = stream;

                        mediaObj.play();

                        stream.getTracks().forEach(track => { peer_connection.addTrack(track, stream); });
                    }, function(error){
                        console.log(error);
                    });

                    /*
                    if (document.location.hash === "" || document.location.hash === undefined) {
                        // create the unique token for this call 
                        var token = Date.now()+"-"+Math.round(Math.random()*10000);
                        var call_token = "#"+token;

                        // set location.hash to the unique token for this call
                        document.location.hash = token;

                        socket.emit("caller_join", {call_token: call_token});

                        document.title = "You are the Caller";
                        $("#loading_state").innerHTML = "Ready for a call...ask your friend to visit:<br/><br/>"+document.location;

                        socket.on("new_ice_candidate", function(message){
                            peer_connection.addIceCandidate(new RTCIceCandidate(message.candidate));
                        });

                        socket.on("callee_join", function(message){
                            peer_connection.createOffer().then(function(description){
                                return peer_connection.setLocalDescription(description);
                            })
                            .then(function(){
                                socket.emit("new_description", {call_token:call_token, sdp:peer_connection.localDescription});
                            })
                            .catch(function(error){
                                console.log(error);
                            });
                        });

                        socket.on("new_description", function(message){
                            peer_connection.setRemoteDescription(new RTCSessionDescription(message.sdp))
                            .then(function(){
                                // if type is answer, can extend this
                            })
                            .catch(function(error){
                                console.log(error);
                            });
                        });
                    }
                    else {
                        var call_token = document.location.hash;

                        socket.emit("callee_join", {call_token: call_token});

                        document.title = "You are the Callee";
                        $("#loading_state").innerHTML = "One moment please...connecting your call...";

                        socket.on("new_ice_candidate", function(message){
                            peer_connection.addIceCandidate(new RTCIceCandidate(message.candidate));
                        });

                        socket.on("new_description", function(message){
                            peer_connection.setRemoteDescription(new RTCSessionDescription(message.sdp))
                            .then(function(){
                                if (peer_connection.remoteDescription.type == "offer") {
                                    peer_connection.createAnswer().then(function(description){
                                        return peer_connection.setLocalDescription(description);
                                    })
                                    .then(function(){
                                        // 
                                        socket.emit("new_description", {call_token:call_token, sdp:peer_connection.localDescription});
                                    })
                                    .catch(function(error){
                                        console.log(error);
                                    })
                                }
                            })
                            .catch(function(error){
                                console.log(error);
                            });
                        });
                    }
                    */
                };

                $("call_btn").onclick(function(){
                    start_fn(true, $("call_token").val());
                });

                $("join_btn").onclick(function(){
                    start_fn(false, $("call_token").val());
                })
            });
        </script>
        <style type="text/css">
            #local_video {
                width: 320px;
                height: 240px;
                border: 1px solid darkgray;
            }

            #remote_video {
                width: 640px;
                height: 480px;
                border: 1px solid darkgray;
            }
        </style>
        <meta charset="UTF-8">
        <title>socket io title</title>
    </head>
    <body>
        <input type="text" id="call_token"></input>
        <input type="button" id="call_btn" value="call"></input>
        <input type="button" id="join_btn" value="join"></input>

        <h1>Received</h1>
        <div id="chat_received">
        </div>

        <form id="chat_broadcast" action="#">
            <input id="input-data" type="text">
            <input type="submit">
        </form>

        <div id="loading_state">
            <p>loading...</p>
        </div>

        <div id="open_call_state">
            <video id="local_video" controls alt="local video"></video>
            <video id="remote_video" controls alt="remote video"></video>
        </div>
    </body>
</html>